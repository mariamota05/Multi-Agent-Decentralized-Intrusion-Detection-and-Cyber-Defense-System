"""
Malware Attacker - Sends malicious payloads to infect systems

ATTACK TYPE: Stealth Malware
────────────────────────────────────────────────────────────────

WHAT IT DOES:
  • Sends low-volume periodic messages containing malware keywords
  • Uses stealth timing to avoid rate-based detection
  • Attempts to install trojans, backdoors, viruses, ransomware
  • CPU load: intensity × 5% for 3 seconds per attack

WHY THIS RESPONSE?
  [+] Immediate permanent block - malware SPREADS fast
  [+] Quarantine advisory - isolate infected systems
  [+] Fastest response (0.3s) - every second counts
  [+] No investigation needed - malware = definite threat

RISK LEVEL: [!] HIGH
  - Can compromise data and spread across network
  - Permanent damage (encryption, data theft, backdoors)
  - Lateral movement if not contained immediately
────────────────────────────────────────────────────────────────

Usage:
  python attackers/malware_attacker.py --jid attacker@localhost --password secret \\
         --targets node1@localhost,node2@localhost --intensity 5 --duration 30
"""

import argparse
import asyncio
import datetime
import getpass
import json

import spade
from spade.agent import Agent
from spade.behaviour import PeriodicBehaviour
from spade.message import Message


def _log(msg: str) -> None:
    ts = datetime.datetime.now().strftime("%H:%M:%S")
    print(f"[{ts}] [MALWARE] {msg}")


class MalwareAttacker(Agent):
    """Sends periodic low-volume malicious messages with malware keywords."""

    class StealthMalwareBehaviour(PeriodicBehaviour):
        """Sends malware payloads slowly to avoid detection."""

        async def on_start(self):
            _log(f"Starting stealth malware attack from {self.agent.jid}")

        async def run(self):
            targets = self.agent.get("targets") or []
            intensity = int(self.agent.get("intensity") or 3)
            
            if not targets:
                return
            
            # Round-robin target selection
            target_index = self.agent.get("target_index") or 0
            target = targets[target_index % len(targets)]
            self.agent.set("target_index", (target_index + 1) % len(targets))
            
            # Malware payloads
            payloads = [
                "ATTACK: Attempting to install trojan backdoor",
                "ATTACK: Trying to inject malware payload",
                "ATTACK: Attempting virus propagation",
                "ATTACK: Trying to deploy ransomware",
                "ATTACK: Attempting worm replication",
                "ATTACK: Trying to exploit system vulnerability"
            ]
            
            # Cycle through payloads
            msg_index = self.agent.get("msg_index") or 0
            payload = payloads[msg_index % len(payloads)]
            self.agent.set("msg_index", (msg_index + 1) % len(payloads))
            
            # Send message with resource load
            msg = Message(to=target)
            msg.set_metadata("protocol", "attack")
            task_data = {
                "cpu_load": intensity * 5.0,  # Malware processing overhead
                "duration": 3.0
            }
            msg.set_metadata("task", json.dumps(task_data))
            msg.body = payload
            await self.send(msg)
            
            _log(f"-> {target}: {payload[:50]}...")
            
            # Check if duration expired
            start_time = self.agent.get("attack_start_time") or 0
            duration = self.agent.get("duration") or 30
            if asyncio.get_event_loop().time() - start_time > duration:
                _log("Attack duration expired - stopping")
                self.kill()

    async def setup(self):
        _log(f"Malware attacker initialized: {self.jid}")
        
        # Store attack start time
        self.set("attack_start_time", asyncio.get_event_loop().time())
        
        # Start stealth malware behavior (period = 4 seconds for stealth)
        intensity = int(self.get("intensity") or 3)
        period = max(2.0, 6.0 - intensity * 0.3)  # Higher intensity = faster attacks
        
        behav = self.StealthMalwareBehaviour(period=period)
        self.add_behaviour(behav)
        
        _log(f"Attack period: {period:.1f}s (intensity={intensity})")


async def main():
    parser = argparse.ArgumentParser(description="Malware Attacker - Sends malicious payloads")
    parser.add_argument("--jid", required=True, help="Attacker JID (e.g., attacker@localhost)")
    parser.add_argument("--password", help="Password (prompted if not provided)")
    parser.add_argument("--targets", required=True, help="Comma-separated target JIDs")
    parser.add_argument("--intensity", type=int, default=5, help="Attack intensity 1-10 (default: 5)")
    parser.add_argument("--duration", type=int, default=30, help="Attack duration in seconds (default: 30)")
    args = parser.parse_args()

    passwd = args.password or getpass.getpass(f"Password for {args.jid}: ")
    targets = [t.strip() for t in args.targets.split(',') if t.strip()]

    agent = MalwareAttacker(args.jid, passwd)
    agent.set("targets", targets)
    agent.set("intensity", args.intensity)
    agent.set("duration", args.duration)

    try:
        await agent.start(auto_register=True)
        _log(f"Agent started - targeting {len(targets)} nodes")
        await spade.wait_until_finished(agent)
    except KeyboardInterrupt:
        _log("Stopping attack...")
    finally:
        await agent.stop()


if __name__ == "__main__":
    spade.run(main())
